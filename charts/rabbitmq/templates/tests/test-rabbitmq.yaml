apiVersion: v1
kind: Pod
metadata:
  name: {{ printf "rabbitmq-test-%s" .Release.Name | trunc 63 | trimSuffix "-" }}
  annotations:
    helm.sh/hook: test-success
spec:
  containers:
  - name: rabbitmq-test
    image: mirantisworkloads/test-base:1.0.0
    imagePullPolicy: IfNotPresent
    env:
    - name: PASSWORD
      valueFrom:
        secretKeyRef:
          name: {{ template "rabbitmq.fullname" . }}
          key: password
    command:
      - "sh"
      - "-cxe"
      - |
        set -o pipefail
        {{- $release := (.Release.Name | trunc 63 | trimSuffix "-") -}}
        {{ range $i, $e := until (int $.Values.replicas) }}
        success=0
        for i in $(seq 1 20); do
          if curl -u {{ $.Values.user }}:$PASSWORD -f {{ printf "rabbitmq-%s-%d.rabbitmq-%s:15672" $release $i $release }}/api/aliveness-test/%2F | [ `jq -r .status` == ok ]; then
            success=1
            break
          else
            sleep 5
          fi
        done
        if [ ${success} -eq 0 ]; then
          exit 1
        fi
        {{ range $j, $er := until (int $.Values.replicas) }}
        curl -u {{ $.Values.user }}:$PASSWORD -f {{ printf "rabbitmq-%s-%d.rabbitmq-%s:15672" $release $i $release }}/api/nodes | [ `jq -r .[{{ $j }}].running` == true ]
        {{- end }}
        {{- end }}
  restartPolicy: Never
